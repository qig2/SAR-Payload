# SAR-Payload
# Instructions on the SAR Project (Software side)

## DJI Official Document
All prototypes are provided by DJI. Please firstly refer to [DJI Official Document](https://developer.dji.com/cn/payload-sdk/documentation/introduction/index.html) when there is a problem. 
Please also refer to the [DJI Developer Forum](https://bbs.dji.com/forum-79-1.html?from=developer).

## Required components
1. `CMake` `Python3` on Raspberry Pi
2. `Payload SDK` installation packet
3. `DJI Assistant 2` installation packet for Matrice 300 RTK
4. `Raspberry Pi 4B+` with `Raspberry Pi OS 32-bit`
5. `USB to tty converter`
6. `Skyport Development board`
7. `Skyport V2`
8. `DJI Matrice 300 RTK`

## Files
Files modified by us are listed below, please refer to the comments on individual files for more information. Files provided with comments are not in their real positions, please note that `Pay5/` is the root folder of the Payload SDK.

- Pay5/sample/api_sample/widget/test_widget.c
- Pay5/sample/api_sample/widget/widget_file/cn_big_screen/widget_config.json
- Pay5/sample/api_sample/widget/widget_file/en_big_screen/widget_config.json
- Pay5/sample/api_sample/camera_media_emu/test_payload_cam_media.c
- Pay5/sample/platform/linux/manifold2/hal/hal_network.c
- Pay5/sample/platform/linux/manifold2/hal/hal_uart.c
- Pay5/sample/platform/linux/mainfold2/project/CMakeLists.txt
- Pay5/sample/platform/linux/mainfold2/project/build/SARimage_python.py
- Pay5/sample/platform/linux/mainfold2/project/build/wKA_fft_1d.py 
- Pay5/sample/platform/linux/mainfold2/project/application/app_info.h
- Pay5/sample/platform/linux/mainfold2/project/application/main.c
- Pay5/sample/platform/linux/mainfold2/project/application/psdk_config.h

## Connections between components
1. Raspberry Pi -> USB to `tty` converter -> `UART` -> `skyport` development board -> `skyport v2` -> drone
2. Raspberry Pi -> Ethernet Connection -> `skyport` development board -> `skyport v2` -> drone
![](DJI%20Skyport%20Development/IMG_3135.HEIC)

## First time setup
1. Apply for Business account.
2. Download `PSDK`, `DJI Assistant 2 `under developer account.
3. Copy the file to Raspberry Pi (Cautious when using a Mac, may encounter problem with `com.apple.quarantine` problem when `make`, recommend to download in Raspberry Pi).
4. Modify some files according to the website’s instructions [Tutorial on modifying the psdk_demo](https://www.freesion.com/article/2294962127/).
5. Follow the DJI Official document for PSDK [DJI PSDK Document](https://developer.dji.com/cn/payload-sdk/documentation/quickstart/run-the-sample.html).
6. Make sure the network port and serial port match with your own configuration. (`ls -l /dev/tty*` and `ls -l /dev/serial*` and `ifconfig`, example serial port `/dev/ttyUSB0` using tty converter, network port `eth0` for ethernet connection)
7. Install `DJI Assistant 2` on your PC, log in your DJI account and connect your drone with PC through the Type-C port on top of the drone.
8. Bind your device on `DJI Assistant 2`.
9. Run the following code on the Raspberry Pi.
```
> cd Pay5/sample/platform/linux/mainfold2/project/build
> cmake.. && make clean && make
> sudo ./SAR_module_adaption
```
10. The `Binding status` of the `DJI Skyport V2` should be `Bound`.

## Possible Errors
1. [PSDK init fail] May not register device on DJI Assistant 2.
2. [Network permission on `./psdk_demo`] Add `sudo` in front.

## Make Project
After modifying any file in the folder, please remake the whole project. 

Before Making the project, please make sure you have the following files in the `build` folder.

- data_subscription_data_in_main.txt
- SAR_start_timestamp.txt
- wKA_fft_1d.py 

Then run the following code in terminal.
```
> cd Pay5/sample/platform/linux/mainfold2/project/build
> cmake.. && make clean && make
> sudo ./SAR_module_adaption
```

## Rough estimation of the start/stop timestamp using python
Please run `find_5_m_s.py`.

## Widget Control
We modified the `Pay5/sample/api_sample/widget/test_widget.c` to implement the widget control. For this function, we first modified the `widget_config.json` file and kept 3 buttons, 1 text box. The detailed information for these three buttons are listed below:        
             
- **Button1**: this button is used to control the power for the SAR module, we directly used the GPIO control for Raspberry Pi in C to control it. You may need to install some libs first.  
E.g. `digitalWrite(1, HIGH);`

- **Button2**: this button is used to start or end the record for waves generated by SAR module, we used the system () function to call the arecord () function or kill it. One thing you need to be attention is that you’d better build a thread for it, or you may get a crash when you next open it for the thread occupation or insufficient cache.  How to build a thread, please refer to the DJI PSDK Document.
At the meantime, we will record the start time stamp or end time stamp for it.

- **Button3**: this function is used to run a python code to generate an image for the data had gotten. We also build a thread for the python code. You need to build a python environment for C first and make sure the python code can be transferred by C language.  The environment includes the Cmake file and your c code who want to use the python code. Do not click the button when your python program is running, or you will get a segment fault and you may need to restart your machine.

Other functions please refer to DJI PSDK Document.

# Instructions on the SAR Project (Hardware side)
Please refer to `hardware/Hardware.docx`.

# Contributions
- Qi GAO (qigao.17@intl.zju.edu.cn)
- Xiaoyu MA (xiaoyu.17@intl.zju.edu.cn)
- Kaiwei SUN (kaiwei.17@intl.zju.edu.cn)
- Zhizhan TANG (zhizhan.17@intl.zju.edu.cn)